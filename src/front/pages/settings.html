<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Settings - AI Chat Assistant</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* same has header in styles*/
        /* lets the label + toggle sit on one line */
        .setting-item__top{
          display:flex;
          align-items:left;
        }

        /* collapsible panel */
        .setting-panel{
          display:none; /* default to not visible */
          overflow:hidden;
          max-height:0;
          opacity:0;
          transform: translateY(-6px);
          transition: max-height 220ms ease, opacity 220ms ease, transform 220ms ease;
          margin-top:10px;
        } .setting-panel.is-open{ max-height:120px; /* increase if you add more stuff */
          display:block;
          opacity:1;
          transform: translateY(0);
        }

        /* slider row layout */
        .slider-row{
          display:flex;
          align-items:center;
          gap:12px;
        }

        .slider-row input[type="range"]{
          flex:1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="container-header">
            <h1>Settings</h1>
            <button class="back-button" onclick="window.location.href='index.html'">Back to Chat</button>
        </div>
        
        <div class="settings-content">
            <div class="setting-group">
                <h2>General</h2>
                <div class="setting-item">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="language">Language</label>
                    <select id="language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-group">
                <h2>AI Model</h2>
                <div class="setting-item">
                    <label for="model">Model</label>
                    <input type="text" id="model" placeholder="e.g., deepseek-r1:latest">
                </div>
                <div class="setting-item">
                    <label for="ollama-endpoint">Ollama API Endpoint</label>
                    <input type="text" id="ollama-endpoint" placeholder="e.g., http://localhost:11434">
                    <p class="help-text">Enter your Ollama API endpoint (e.g., http://localhost:11434)</p>
                </div>
                <div class="setting-item setting-item--stack">
                  <div class="setting-item__top">
                    <label for="temperature">Creativity Level</label>

                    <label class="toggle">
                      <input id="tempEnable" type="checkbox" />
                      <span class="toggle-box" aria-hidden="true"></span>
                      <span class="toggle-label">Enable</span>
                    </label>
                  </div>

                  <div id="temperatureSlider" class="setting-panel" aria-hidden="true">
                    <div class="slider-row">
                      <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                      <span id="temperature-value">0.7</span>
                    </div>
                    <p class="help-text">Higher = more creative, lower = more deterministic.</p>
                  </div>
                </div>
            </div>

            <div class="setting-group">
                <h2>Advanced</h2>
                <div class="setting-item">
                    <label for="prepended-prompt">Prepend Prompt</label>
                    <input type="text" id="prepended-prompt" placeholder="e.g., YOU ARE A SENIOR DEVELOPER">
                </div>
                <div class="setting-item">
                    <label for="appended-prompt">Append Prompt</label>
                    <input type="text" id="appended-prompt" placeholder="e.g., print 'moo' if you understand">
                </div>
                <div class="setting-item">
                    <label for="max-tokens">Max Tokens</label>
                    <input type="number" id="max-tokens" value="1000" min="100" max="4000">
                </div>
                <div class="setting-item">
                    <label for="timeout">Timeout (seconds)</label>
                    <input type="number" id="timeout" value="30" min="5" max="120">
                </div>
            </div>

            <div class="setting-group">
                <h2>Privacy</h2>
                <div class="setting-item checkbox">
                    <input type="checkbox" id="save-history">
                    <label for="save-history">Save chat history</label>
                </div>
                
                <div class="setting-item checkbox">
                    <input type="checkbox" id="auto-save">
                    <label for="auto-save">Auto-save conversations</label>
                </div>
                
                <div class="setting-item checkbox">
                    <input type="checkbox" id="analytics">
                    <label for="analytics">Send anonymous analytics</label>
                </div>
            </div>
            
        </div>
        
        <div class="settings-footer">
            <button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>
            <button class="save-button" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <script>
        // Load settings when page loads
        window.addEventListener('load', async function() {
            try {
                console.log('Loading settings...');
                // Load all settings
                const theme = await window.settings.getTheme();
                const language = await window.settings.getLanguage();
                const model = await window.settings.getModel();
                const temperature = await window.settings.getTemperature();
                const saveHistory = await window.settings.getSaveHistory();
                const autoSave = await window.settings.getAutoSave();
                const analytics = await window.settings.getAnalytics();
                const ollamaEndpoint = await window.settings.getOllamaBaseUrl();
                const maxTokens = await window.settings.getMaxTokens();
                const timeout = await window.settings.getTimeout();
                
                // Set values in UI
                document.getElementById('theme').value = theme;
                document.getElementById('language').value = language;
                document.getElementById('model').value = model;
                document.getElementById('temperature').value = temperature;
                document.getElementById('temperature-value').textContent = temperature;
                document.getElementById('save-history').checked = saveHistory;
                document.getElementById('auto-save').checked = autoSave;
                document.getElementById('analytics').checked = analytics;
                document.getElementById('ollama-endpoint').value = ollamaEndpoint;
                document.getElementById('max-tokens').value = maxTokens;
                document.getElementById('timeout').value = timeout;
                
                console.log('Settings loaded successfully');
                
                // Check if endpoint is saved and show banner if not
            } catch (error) {
                console.error('Error loading settings:', error);
                // Show banner if we can't load settings
                showBanner();
            }
        });

        async function call(name, fn) {
          console.log(`→ saving ${name}`);
          try {
            const result = await fn();
            console.log(`✓ saved ${name}`, result);
            return result;
          } catch (error) {
            console.error(`Error saving ${name}:`, error);
            throw error;
          }
        }
        
        // Update temperature value display
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('temperature-value').textContent = this.value;
        });
        
        // Save settings function
        async function saveSettings() {
            console.log('Saving settings...');
            try {
                const theme = document.getElementById('theme').value;
                const language = document.getElementById('language').value;
                const model = document.getElementById('model').value;
                const tempEnabled = document.getElementById('tempEnable').checked;
                const temperature = document.getElementById('temperature').value;
                const saveHistory = document.getElementById('save-history').checked;
                const autoSave = document.getElementById('auto-save').checked;
                const analytics = document.getElementById('analytics').checked;
                const ollamaEndpoint = document.getElementById('ollama-endpoint').value;
                const maxTokens = document.getElementById('max-tokens').value;
                const timeout = document.getElementById('timeout').value;

                
                // Save all settings
                await call('theme', () => window.settings.setTheme(theme));
                await call('language', () => window.settings.setLanguage(language));
                await call('model', () => window.settings.setModel(model));
                await call('tempEnabled', () => window.settings.setTempEnabled(tempEnabled));
                await call('temperature', () => window.settings.setTemperature(temperature));
                await call('saveHistory', () => window.settings.setSaveHistory(saveHistory));
                await call('autoSave', () => window.settings.setAutoSave(autoSave));
                await call('analytics', () => window.settings.setAnalytics(analytics));
                await call('ollamaBaseUrl', () => window.settings.setOllamaBaseUrl(ollamaEndpoint));
                await call('maxTokens', () => window.settings.setMaxTokens(maxTokens));
                await call('timeout', () => window.settings.setTimeout(timeout));
                
                // Hide banner if endpoint was saved
                if (ollamaEndpoint) {
                    hideBanner();
                }
                
                console.log('Settings saved successfully');
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }
        
        // Reset to defaults
        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                try {
                    await window.settings.resetToDefaults();
                    // Reload page to apply defaults
                    window.location.reload();
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    alert('Error resetting settings');
                }
            }
        }
        
        function showBanner() {
            console.log('Showing endpoint banner');
            document.getElementById('endpoint-banner').classList.add('show');
        }
        
        function hideBanner() {
            console.log('Hiding endpoint banner');
            document.getElementById('endpoint-banner').classList.remove('show');
        }
        
        function saveEndpoint() {
            const endpoint = document.getElementById('banner-endpoint').value;
            if (endpoint) {
                console.log('Saving endpoint:', endpoint);
                window.settings.setOllamaBaseUrl(endpoint);
                hideBanner();
            }
        }

        // Temperature Slider appear/disappear
        const tempEnable = document.getElementById('tempEnable');
        const temperatureSlider = document.getElementById('temperatureSlider');

        function setTempSliderVisible(enabled) {
          temperatureSlider.classList.toggle('is-open', enabled);
          temperatureSlider.setAttribute('aria-hidden', String(!enabled));
        }

        tempEnable.addEventListener('change', () => {
          setTempSliderVisible(tempEnable.checked);
        });

        // make sure it’s correct on first render
        setTempSliderVisible(tempEnable.checked);
        window.addEventListener('DOMContentLoaded', async () => {
          const tempEnable = document.getElementById('tempEnable');
          const temperatureSlider = document.getElementById('temperatureSlider');
          const temperature = document.getElementById('temperature');
          const temperatureValue = document.getElementById('temperature-value');

          function setTempSliderVisible(enabled) {
            temperatureSlider.classList.toggle('is-open', enabled);
            temperatureSlider.setAttribute('aria-hidden', String(!enabled));
          }

          // slider value text
          temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
          });

          // checkbox toggles visibility
          tempEnable.addEventListener('change', () => {
            setTempSliderVisible(tempEnable.checked);
          });

          // initial state: hidden until checked
          setTempSliderVisible(tempEnable.checked);

          // OPTIONAL: if you want it checked when a saved temperature exists
          // (or when you later add a dedicated tempEnabled setting)
          try {
            const savedTemp = await window.settings.getTemperature();
            temperature.value = savedTemp;
            temperatureValue.textContent = savedTemp;

            // if you want slider to appear automatically when temp exists:
            // tempEnable.checked = true;
            // setTempSliderVisible(true);
          } catch (e) {
            console.warn('Could not load temperature:', e);
          }
        });
    </script>
</body>
</html>
