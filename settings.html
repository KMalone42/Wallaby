<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Settings - AI Chat Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            display: none;
        }
        
        .banner.show {
            display: block;
        }
        
        .banner input {
            padding: 8px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            width: 300px;
        }
        
        .banner button {
            padding: 8px 15px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .banner .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .banner .cancel-btn {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="banner" id="endpoint-banner">
        <span>Enter your Ollama API endpoint:</span>
        <input type="text" id="banner-endpoint" placeholder="e.g., http://localhost:11434">
        <button class="save-btn" onclick="saveEndpoint()">Save</button>
        <button class="cancel-btn" onclick="hideBanner()">Cancel</button>
    </div>
    
    <div class="settings-container">
        <div class="settings-header">
            <h1>Settings</h1>
            <button class="back-button" onclick="window.location.href='index.html'">Back to Chat</button>
        </div>
        
        <div class="settings-content">
            <div class="setting-group">
                <h2>General</h2>
                <div class="setting-item">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="language">Language</label>
                    <select id="language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-group">
                <h2>AI Model</h2>
                <div class="setting-item">
                    <label for="model">Model</label>
                    <select id="model">
                        <option value="gpt-3.5">GPT-3.5</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="claude">Claude</option>
                        <option value="llama">Llama 2</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="temperature">Creativity Level</label>
                    <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                    <span id="temperature-value">0.7</span>
                </div>
            </div>
            
            <div class="setting-group">
                <h2>Privacy</h2>
                <div class="setting-item checkbox">
                    <input type="checkbox" id="save-history">
                    <label for="save-history">Save chat history</label>
                </div>
                
                <div class="setting-item checkbox">
                    <input type="checkbox" id="auto-save">
                    <label for="auto-save">Auto-save conversations</label>
                </div>
                
                <div class="setting-item checkbox">
                    <input type="checkbox" id="analytics">
                    <label for="analytics">Send anonymous analytics</label>
                </div>
            </div>
            
            <div class="setting-group">
                <h2>Advanced</h2>
                <div class="setting-item">
                    <label for="ollama-endpoint">Ollama API Endpoint</label>
                    <input type="text" id="ollama-endpoint" placeholder="e.g., http://localhost:11434">
                    <p class="help-text">Enter your Ollama API endpoint (e.g., http://localhost:11434)</p>
                </div>
                
                <div class="setting-item">
                    <label for="max-tokens">Max Tokens</label>
                    <input type="number" id="max-tokens" value="1000" min="100" max="4000">
                </div>
                
                <div class="setting-item">
                    <label for="timeout">Timeout (seconds)</label>
                    <input type="number" id="timeout" value="30" min="5" max="120">
                </div>
            </div>
        </div>
        
        <div class="settings-footer">
            <button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>
            <button class="save-button" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <script>
        // Ensure we have access to ipcRenderer
        const { ipcRenderer } = require('electron');

        // Make window.settings exist
        window.settings = {
          getTheme: () => ipcRenderer.invoke('settings:getTheme'),
          setTheme: (v) => ipcRenderer.invoke('settings:setTheme', v),

          getLanguage: () => ipcRenderer.invoke('settings:getLanguage'),
          setLanguage: (v) => ipcRenderer.invoke('settings:setLanguage', v),

          getModel: () => ipcRenderer.invoke('settings:getModel'),
          setModel: (v) => ipcRenderer.invoke('settings:setModel', v),

          getTemperature: () => ipcRenderer.invoke('settings:getTemperature'),
          setTemperature: (v) => ipcRenderer.invoke('settings:setTemperature', v),

          getSaveHistory: () => ipcRenderer.invoke('settings:getSaveHistory'),
          setSaveHistory: (v) => ipcRenderer.invoke('settings:setSaveHistory', v),

          getAutoSave: () => ipcRenderer.invoke('settings:getAutoSave'),
          setAutoSave: (v) => ipcRenderer.invoke('settings:setAutoSave', v),

          getAnalytics: () => ipcRenderer.invoke('settings:getAnalytics'),
          setAnalytics: (v) => ipcRenderer.invoke('settings:setAnalytics', v),

          getOllamaBaseUrl: () => ipcRenderer.invoke('settings:getOllamaBaseUrl'),
          setOllamaBaseUrl: (v) => ipcRenderer.invoke('settings:setOllamaBaseUrl', v),

          getMaxTokens: () => ipcRenderer.invoke('settings:getMaxTokens'),
          setMaxTokens: (v) => ipcRenderer.invoke('settings:setMaxTokens', v),

          getTimeout: () => ipcRenderer.invoke('settings:getTimeout'),
          setTimeout: (v) => ipcRenderer.invoke('settings:setTimeout', v),

          resetToDefaults: () => ipcRenderer.invoke('settings:resetToDefaults'),
        };

        // Load settings when page loads
        window.addEventListener('load', async function() {
            try {
                console.log('Loading settings...');
                // Load all settings
                const theme = await window.settings.getTheme();
                const language = await window.settings.getLanguage();
                const model = await window.settings.getModel();
                const temperature = await window.settings.getTemperature();
                const saveHistory = await window.settings.getSaveHistory();
                const autoSave = await window.settings.getAutoSave();
                const analytics = await window.settings.getAnalytics();
                const ollamaEndpoint = await window.settings.getOllamaBaseUrl();
                const maxTokens = await window.settings.getMaxTokens();
                const timeout = await window.settings.getTimeout();
                
                // Set values in UI
                document.getElementById('theme').value = theme;
                document.getElementById('language').value = language;
                document.getElementById('model').value = model;
                document.getElementById('temperature').value = temperature;
                document.getElementById('temperature-value').textContent = temperature;
                document.getElementById('save-history').checked = saveHistory;
                document.getElementById('auto-save').checked = autoSave;
                document.getElementById('analytics').checked = analytics;
                document.getElementById('ollama-endpoint').value = ollamaEndpoint;
                document.getElementById('max-tokens').value = maxTokens;
                document.getElementById('timeout').value = timeout;
                
                console.log('Settings loaded successfully');
                
                // Check if endpoint is saved and show banner if not
                if (!ollamaEndpoint || ollamaEndpoint === 'http://localhost:11434') {
                    showBanner();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Show banner if we can't load settings
                showBanner();
            }
        });

        async function call(name, fn) {
          console.log(`→ saving ${name}`);
          try {
            const result = await fn();
            console.log(`✓ saved ${name}`, result);
            return result;
          } catch (error) {
            console.error(`Error saving ${name}:`, error);
            throw error;
          }
        }
        
        // Update temperature value display
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('temperature-value').textContent = this.value;
        });
        
        // Save settings function
        async function saveSettings() {
            console.log('Saving settings...');
            try {
                const theme = document.getElementById('theme').value;
                const language = document.getElementById('language').value;
                const model = document.getElementById('model').value;
                const temperature = document.getElementById('temperature').value;
                const saveHistory = document.getElementById('save-history').checked;
                const autoSave = document.getElementById('auto-save').checked;
                const analytics = document.getElementById('analytics').checked;
                const ollamaEndpoint = document.getElementById('ollama-endpoint').value;
                const maxTokens = document.getElementById('max-tokens').value;
                const timeout = document.getElementById('timeout').value;
                
                // Save all settings
                await call('theme', () => window.settings.setTheme(theme));
                await call('language', () => window.settings.setLanguage(language));
                await call('model', () => window.settings.setModel(model));
                await call('temperature', () => window.settings.setTemperature(temperature));
                await call('saveHistory', () => window.settings.setSaveHistory(saveHistory));
                await call('autoSave', () => window.settings.setAutoSave(autoSave));
                await call('analytics', () => window.settings.setAnalytics(analytics));
                await call('ollamaBaseUrl', () => window.settings.setOllamaBaseUrl(ollamaEndpoint));
                await call('maxTokens', () => window.settings.setMaxTokens(maxTokens));
                await call('timeout', () => window.settings.setTimeout(timeout));
                
                // Hide banner if endpoint was saved
                if (ollamaEndpoint) {
                    hideBanner();
                }
                
                console.log('Settings saved successfully');
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }
        
        // Reset to defaults
        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                try {
                    await window.settings.resetToDefaults();
                    // Reload page to apply defaults
                    window.location.reload();
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    alert('Error resetting settings');
                }
            }
        }
        
        function showBanner() {
            console.log('Showing endpoint banner');
            document.getElementById('endpoint-banner').classList.add('show');
        }
        
        function hideBanner() {
            console.log('Hiding endpoint banner');
            document.getElementById('endpoint-banner').classList.remove('show');
        }
        
        function saveEndpoint() {
            const endpoint = document.getElementById('banner-endpoint').value;
            if (endpoint) {
                console.log('Saving endpoint:', endpoint);
                window.settings.setOllamaBaseUrl(endpoint);
                hideBanner();
            }
        }
    </script>
</body>
</html>
